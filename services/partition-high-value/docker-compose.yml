version: '3.8'

# P3 High-Value Partition Service - Local Development
#
# Chains: Ethereum, zkSync, Linea
# Region: Oracle Cloud US-East (us-east1)
#
# Usage:
#   docker-compose up -d          # Start service
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop service

services:
  partition-high-value:
    build:
      context: ../..
      dockerfile: services/partition-high-value/Dockerfile
    container_name: partition-high-value
    environment:
      # Partition configuration
      - PARTITION_ID=high-value
      - PARTITION_CHAINS=ethereum,zksync,linea

      # Health check
      - HEALTH_CHECK_PORT=3003

      # Redis connection (use host network for local Redis)
      - REDIS_URL=${REDIS_URL:-redis://host.docker.internal:6379}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Region and instance configuration
      - REGION_ID=us-east1
      - INSTANCE_ID=${INSTANCE_ID:-}
      - ENABLE_CROSS_REGION_HEALTH=${ENABLE_CROSS_REGION_HEALTH:-true}

      # RPC endpoints (provide your own keys for production)
      # Falls back to public RPCs if not provided (rate-limited)
      - ETHEREUM_RPC_URL=${ETHEREUM_RPC_URL:-}
      - ETHEREUM_WS_URL=${ETHEREUM_WS_URL:-}
      - ZKSYNC_RPC_URL=${ZKSYNC_RPC_URL:-}
      - ZKSYNC_WS_URL=${ZKSYNC_WS_URL:-}
      - LINEA_RPC_URL=${LINEA_RPC_URL:-}
      - LINEA_WS_URL=${LINEA_WS_URL:-}

      # Alchemy API key for Ethereum mainnet
      # Note: ALCHEMY_API_KEY is the primary key used by chain config
      - ALCHEMY_API_KEY=${ALCHEMY_API_KEY:-}

    ports:
      - "3003:3003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3003/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 15s
    networks:
      - arbitrage-network
    labels:
      - "service=partition-high-value"
      - "partition.id=high-value"
      - "partition.chains=ethereum,zksync,linea"
      - "partition.region=us-east1"

# Network configuration with fallback for isolated development
# - If running standalone: network is created automatically
# - If running with full stack: connects to existing arbitrage-network
# To use external network: docker network create arbitrage-network
networks:
  arbitrage-network:
    name: arbitrage-network
    # Note: Remove 'external: true' to allow auto-creation for standalone development
    # Set external: true when running with the full arbitrage stack
