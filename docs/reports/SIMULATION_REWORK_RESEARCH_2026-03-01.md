# Simulation Rework Research Report

**Date**: 2026-03-01
**Status**: Research Complete — Pending Implementation
**Scope**: Price data simulation realism, strategy coverage gaps, event flooding

---

## Executive Summary

The current price simulation system generates **~600 sync events/second** across 11 chains using a flat 1000ms interval, regardless of actual block times. It only produces **5 of 13** strategy types and uses a type value (`intra-chain`) that doesn't exist in the main `ArbitrageOpportunity.type` enum. This report recommends an activity-weighted tiered model with block-time alignment to reduce event rate to ~50-100/s, cover all 13 strategy types, and fix the type mismatch bug.

---

## 1. Current State Analysis

### Architecture

The simulation system has 3 simulators:

| Simulator | File | Purpose |
|-----------|------|---------|
| `PriceSimulator` | `shared/core/src/simulation/price-simulator.ts` | Global price feed (event emitter) |
| `ChainSimulator` | `shared/core/src/simulation/chain-simulator.ts` | Per-chain Sync events for detector pipeline |
| `CrossChainSimulator` | `shared/core/src/simulation/cross-chain-simulator.ts` | Cross-chain price differentials |

The `ChainSimulator` is the primary one that feeds the detection pipeline via:
```
SimulationInitializer → ChainSimulationHandler → Sync events → pair reserve updates → arbitrage detection
```

### Current Default Config (`constants.ts:15-51`)

```typescript
updateIntervalMs: 1000   // flat for ALL chains
volatility: 0.02         // 2%
arbitrageChance: 0.08    // 8% per tick per chain
dexesPerChain: 2
```

### Problem 1: Price Flooding

Every tick updates **ALL pairs simultaneously** for every chain at 1000ms intervals. With 11 chains × ~13 common pairs × 2-3 DEXes = **~570-850 sync events per second**.

In production:
- Not all pairs trade in every block
- Block times vary wildly: Ethereum 12s, BSC 3s, Arbitrum 0.25s, Solana 0.4s
- Only ~10-20% of tracked pairs see activity in any given block

| Chain | Real Block Time | Sim Interval | Error Factor | Source |
|-------|----------------|--------------|-------------|--------|
| Ethereum | 12,000ms | 1,000ms | **12x too fast** | `shared/config/src/chains/index.ts:248` |
| BSC | 3,000ms | 1,000ms | **3x too fast** | `shared/config/src/chains/index.ts:138` |
| Polygon | 2,000ms | 1,000ms | 2x too fast | `shared/config/src/chains/index.ts:193` |
| Arbitrum | 250ms | 1,000ms | **4x too slow** | `shared/config/src/chains/index.ts:112` |
| Optimism | 2,000ms | 1,000ms | 2x too fast | `shared/config/src/chains/index.ts:163` |
| Base | 2,000ms | 1,000ms | 2x too fast | `shared/config/src/chains/index.ts:220` |
| Avalanche | 2,000ms | 1,000ms | 2x too fast | `shared/config/src/chains/index.ts:282` |
| Fantom | 1,000ms | 1,000ms | correct (by accident) | `shared/config/src/chains/index.ts:309` |
| zkSync | 1,000ms | 1,000ms | correct (by accident) | `shared/config/src/chains/index.ts:337` |
| Linea | 2,000ms | 1,000ms | 2x too fast | `shared/config/src/chains/index.ts:362` |
| Solana | 400ms | 1,000ms | **2.5x too slow** | `shared/config/src/chains/index.ts:495` |

The system already has `BLOCK_TIMES_MS` pre-computed at `shared/config/src/chains/index.ts:625` but the simulator ignores it entirely.

### Problem 2: Missing Strategy Types (CRITICAL)

The simulation generates only **5 of 13** strategy types, AND uses a type (`intra-chain`) that doesn't exist in `ArbitrageOpportunity.type`:

| Type | In `ArbitrageOpportunity.type` | Generated by Sim? | Source |
|------|------|------|------|
| `simple` | Yes | Only Solana non-EVM | `chain.simulator.ts:242` |
| `cross-dex` | Yes | **NEVER** | — |
| `intra-dex` | Yes | **NEVER** | — |
| `triangular` | Yes | Yes (~5% × arbitrageChance) | `chain-simulator.ts:409` |
| `quadrilateral` | Yes | Yes (~1.5% × arbitrageChance) | `chain-simulator.ts:409` |
| `flash-loan` | Yes | Yes (30% of base opps) | `chain-simulator.ts:329-337` |
| `cross-chain` | Yes | Yes (CrossChainSimulator) | `cross-chain-simulator.ts:217` |
| `backrun` | Yes | **NEVER** | — |
| `uniswapx` | Yes | **NEVER** | — |
| `statistical` | Yes | **NEVER** | — |
| `predictive` | Yes | **NEVER** | — |
| `multi-leg` | Yes | **NEVER** | — |
| `solana` | Yes | **NEVER** (explicit type) | — |
| `intra-chain` | **NO — type mismatch!** | Yes (70% of EVM opps) | `chain-simulator.ts:323-328` |

**Bug**: `SimulatedOpportunityType` at `types.ts:67-72` defines `'intra-chain'` but `ArbitrageOpportunity.type` at `shared/types/src/index.ts:181` has `'simple' | 'cross-dex' | 'intra-dex'` instead. The `intra-chain` type falls through to the default in the strategy factory (`strategy-factory.ts:470-477`), but metrics and logging are wrong.

### Problem 3: Unrealistic Update Patterns

- All pairs update uniformly every tick — no activity weighting
- Constant volatility — no quiet/burst regimes
- No correlation between pairs (whale buys ETH → all ETH pairs should move)
- No volume data variation (fixed random liquidity/volume in `price-simulator.ts:154`)

**Root Cause**: The simulation was built as a minimal "make it work" implementation — a flat `setInterval` with uniform random walk. It was never designed to model actual blockchain activity patterns.

---

## 2. Industry Best Practices

| Approach | Used By | Pros | Cons | Effort |
|----------|---------|------|------|--------|
| **A. Block-time-aligned intervals** | Flashbots sim, internal DEX testing | + Matches real chain cadence, + Uses existing `BLOCK_TIMES_MS` | - Still uniform within block | 1-2 days |
| **B. Poisson-process event model** | Quantitative trading firms (estimated, MEDIUM confidence) | + Statistically realistic inter-event times, + Natural burst/quiet | - More complex, - Harder to tune | 3-4 days |
| **C. Replay real data** | Jump Trading, Wintermute (estimated, LOW confidence) | + Most realistic possible, + Real market microstructure | - Requires data collection infra, - Large storage | 5+ days |
| **D. Activity-weighted tiered model** | Custom (hybrid of A+B) | + Block-aligned + pair-weighted, + Simple to tune, + Low effort | - Still synthetic | 2-3 days |
| **E. Full market simulator** | Paradigm, 0x (estimated, LOW confidence) | + Complete fidelity, + MEV modeling | - Massive scope, - Overkill for dev mode | 10+ days |

---

## 3. Recommended Solution

**Approach**: D — Activity-weighted tiered model with block-time alignment
**Confidence**: HIGH (90%)

**Justification**: Best ratio of realism to effort. Solves all three problems:
1. Uses real `BLOCK_TIMES_MS` per chain → eliminates flooding
2. Activity tiers per pair → realistic sparse updates
3. Full strategy type coverage → no gaps

**Why NOT alternatives**:
- **A alone**: Still floods because all pairs update every block
- **B (Poisson)**: Mathematically elegant but harder to debug and tune; marginal gain over tier model for dev mode
- **C (Replay)**: Requires data pipeline that doesn't exist; overkill for local dev
- **E (Full sim)**: Massive scope creep; we just need dev mode to not flood

**Expected Impact**:
- Event rate: **~600/s → ~50-100/s** (6-12x reduction)
- Strategy coverage: **5/13 → 13/13** (complete)
- Type correctness: Fix `intra-chain` → `simple`/`cross-dex`/`intra-dex` mapping

**ADR Compatibility**: No conflicts with ADR-002 (Redis Streams), ADR-003 (Partitions), ADR-005 (Price Matrix), ADR-022 (Hot Path). This is simulation-only code (WARM path, not hot path).

---

## 4. Implementation Tasks

| # | Task | Effort | Confidence | Dependencies | Test Strategy |
|---|------|--------|------------|--------------|---------------|
| 1 | Add `BLOCK_TIMES_MS` import to chain-simulator and use per-chain block time as update interval | 0.5d | 95% | None | Unit: verify interval matches chain config |
| 2 | Add pair activity tiers (high/medium/low) with per-tick selection probability | 1d | 90% | None | Unit: verify pair update frequency distribution |
| 3 | Fix `SimulatedOpportunityType` to use `ArbitrageOpportunity.type` values (`simple`, `cross-dex`, `intra-dex` instead of `intra-chain`) | 0.5d | 95% | None | Unit: verify type values match `shared/types` |
| 4 | Add strategy generators for missing types: `backrun`, `uniswapx`, `statistical`, `predictive`, `multi-leg`, `solana` | 1.5d | 85% | Task 3 | Unit: each generator emits valid opportunity |
| 5 | Add market regime modeling (quiet/normal/burst) to `simulateTick()` | 0.5d | 90% | Task 2 | Unit: verify regime distribution affects volatility and pair selection |
| 6 | Wire Solana simulator to emit `type: 'solana'` explicitly | 0.25d | 95% | Task 3 | Unit: Solana opportunities have correct type |
| 7 | Add env var `SIMULATION_REALISM_LEVEL` (low/medium/high) to control how realistic the simulation is | 0.25d | 90% | Tasks 1-6 | Unit: each level produces expected behavior |

**Total estimated effort**: 4.5 days
**Recommended execution order**: 3 → 1 → 2 → 5 → 4 → 6 → 7 (type fix first since it's a bug)

---

## 5. Risk Analysis

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Lower event rate causes detection pipeline to appear idle | LOW | MEDIUM | Add `SIMULATION_REALISM_LEVEL=low` option that keeps current fast rate for quick testing |
| Strategy generators produce invalid opportunities that crash execution engine | MEDIUM | HIGH | Validate all generated opportunities against `ArbitrageOpportunity` type; add runtime assertions matching existing `validateOpportunityTypeConsistency` pattern |
| Changing `SimulatedOpportunityType` breaks existing tests | MEDIUM | LOW | Find/replace `intra-chain` → `cross-dex` in test assertions; add migration notes |
| Block-time intervals too slow for quick dev iteration | LOW | LOW | `SIMULATION_REALISM_LEVEL=low` keeps 1000ms flat interval as escape hatch |

---

## 6. Success Metrics

- [ ] **Event rate**: ~600/s → ~50-100/s — Measure with `detector.getStats().totalEventsProcessed` over 60s
- [ ] **Strategy coverage**: 5/13 → 13/13 — Count distinct `opportunity.type` values in a 5-minute window
- [ ] **Type correctness**: 0 instances of `intra-chain` in emitted opportunities — Grep logs for type field
- [ ] **Chain timing accuracy**: Each chain's event interval within 20% of `BLOCK_TIMES_MS[chain]` — Measure actual intervals
- [ ] **No test regressions**: All existing tests pass after changes — `npm test`

---

## 7. ADR Recommendation

**New ADR Needed?**: No — this is an internal simulation quality improvement, not an architectural decision. Document changes in the simulation module's JSDoc comments.

---

## 8. Detailed Design

### 8.1 Block-Time-Aligned Intervals

**File**: `shared/core/src/simulation/chain-simulator.ts`

Replace:
```typescript
// Current: flat interval for all chains
this.interval = setInterval(() => {
  this.simulateTick();
}, this.config.updateIntervalMs);  // Always 1000ms
```

With:
```typescript
// New: use real block time from chain config
import { getBlockTimeMs } from '@arbitrage/config';

const blockTimeMs = getBlockTimeMs(this.config.chainId);
this.interval = setInterval(() => {
  this.simulateTick();
}, blockTimeMs);
```

Also update `getChainSimulator()` factory to pass block time through config, and allow `SIMULATION_UPDATE_INTERVAL_MS` env var to override for testing.

### 8.2 Pair Activity Tiers

**New constant in `constants.ts`**:

```typescript
/**
 * Pair activity probability — chance a pair has a trade in any given block.
 * Based on typical DEX trading patterns:
 * - Tier 1 (blue-chip): active in 60-80% of blocks
 * - Tier 2 (medium): active in 20-40% of blocks
 * - Tier 3 (low-cap): active in 3-10% of blocks
 */
export const PAIR_ACTIVITY_TIERS: Record<string, number> = {
  // Tier 1: Blue-chip pairs
  'WETH/USDC': 0.75, 'WETH/USDT': 0.70, 'WBTC/WETH': 0.65, 'WBTC/USDC': 0.60,
  'WBNB/BUSD': 0.70, 'WBNB/USDT': 0.65, 'SOL/USDC': 0.75,

  // Tier 2: Medium pairs
  'ARB/WETH': 0.35, 'OP/WETH': 0.30, 'LINK/WETH': 0.30,
  'MATIC/USDC': 0.35, 'AVAX/USDC': 0.30, 'FTM/USDC': 0.25,
  'ARB/USDC': 0.30, 'OP/USDC': 0.25, 'JUP/SOL': 0.30,

  // Tier 3: Low-cap/chain-specific pairs
  'PEPE/WETH': 0.08, 'SHIB/WETH': 0.06, 'BONK/SOL': 0.10,
  'CAKE/WBNB': 0.15, 'JOE/WAVAX': 0.12, 'AERO/WETH': 0.15,
  'VELO/WETH': 0.10, 'QUICK/WMATIC': 0.08,
  'stETH/WETH': 0.20, 'rETH/WETH': 0.18, 'wstETH/WETH': 0.22,
  'mSOL/SOL': 0.25, 'jitoSOL/SOL': 0.20,
};

export const DEFAULT_PAIR_ACTIVITY = 0.15; // 15% for unlisted pairs
```

**Usage in `simulateTick()`**:

```typescript
for (let i = 0; i < this.config.pairs.length; i++) {
  const pair = this.config.pairs[i];
  const pairKey = `${pair.token0Symbol}/${pair.token1Symbol}`;
  const activity = PAIR_ACTIVITY_TIERS[pairKey] ?? DEFAULT_PAIR_ACTIVITY;

  // Apply regime multiplier
  const effectiveActivity = activity * this.regimeMultiplier;

  // Skip this pair if no trade this block
  if (Math.random() > effectiveActivity) continue;

  // ... existing reserve update logic
}
```

### 8.3 Fix SimulatedOpportunityType

**File**: `shared/core/src/simulation/types.ts:67-72`

Replace:
```typescript
export type SimulatedOpportunityType =
  | 'intra-chain'
  | 'cross-chain'
  | 'flash-loan'
  | 'triangular'
  | 'quadrilateral';
```

With:
```typescript
export type SimulatedOpportunityType =
  | 'simple'
  | 'cross-dex'
  | 'intra-dex'
  | 'cross-chain'
  | 'flash-loan'
  | 'triangular'
  | 'quadrilateral'
  | 'multi-leg'
  | 'backrun'
  | 'uniswapx'
  | 'statistical'
  | 'predictive'
  | 'solana';
```

**File**: `shared/core/src/simulation/chain-simulator.ts:322-338`

Replace `intra-chain` with proper type selection:
```typescript
if (rand < 0.30) {
  opportunity = { ...baseOpportunity, type: 'cross-dex', useFlashLoan: false };
} else if (rand < 0.50) {
  opportunity = { ...baseOpportunity, type: 'simple', useFlashLoan: false };
} else if (rand < 0.55) {
  opportunity = { ...baseOpportunity, type: 'intra-dex', useFlashLoan: false };
} else if (rand < 0.67) {
  // flash-loan
  const flashLoanFee = 0.0009;
  opportunity = {
    ...baseOpportunity,
    type: 'flash-loan',
    useFlashLoan: true,
    flashLoanFee,
    expectedProfit: estimatedProfitUsd * (1 - flashLoanFee) - estimatedGasCost,
  };
} else if (rand < 0.73) {
  opportunity = createBackrunOpportunity(baseOpportunity);
} else if (rand < 0.78) {
  opportunity = createStatisticalOpportunity(baseOpportunity);
} else if (rand < 0.81) {
  opportunity = createUniswapXOpportunity(baseOpportunity);
} else if (rand < 0.83) {
  opportunity = createPredictiveOpportunity(baseOpportunity);
} else {
  opportunity = createMultiLegOpportunity(baseOpportunity);
}
```

### 8.4 Strategy Distribution Weights

```typescript
/**
 * Strategy type distribution weights for realistic simulation.
 * Weights sum to 1.0 and reflect typical mainnet opportunity distribution.
 *
 * cross-dex dominates because most real arbitrage is between DEXes on the same chain.
 * Cross-chain is handled separately by CrossChainSimulator.
 * Solana-specific type is handled by the non-EVM simulator.
 */
export const STRATEGY_WEIGHTS: Record<SimulatedOpportunityType, number> = {
  'cross-dex': 0.30,       // Most common: same tokens, different DEXes
  'simple': 0.20,          // Two-pool on same DEX (price lag between V2/V3)
  'flash-loan': 0.12,      // Capital-free execution
  'triangular': 0.08,      // 3-hop cycle (A → B → C → A)
  'backrun': 0.06,         // MEV-Share backrun
  'intra-dex': 0.05,       // Same DEX, different pool types (V2 vs V3)
  'statistical': 0.05,     // Mean-reversion / cointegration
  'cross-chain': 0.04,     // Handled primarily by CrossChainSimulator
  'uniswapx': 0.03,        // Dutch auction fills
  'predictive': 0.02,      // ML-based prediction
  'quadrilateral': 0.02,   // 4-hop cycle
  'multi-leg': 0.02,       // N-hop paths
  'solana': 0.01,          // Solana-specific (mostly from P4)
};
```

### 8.5 Market Regime Model

```typescript
type MarketRegime = 'quiet' | 'normal' | 'burst';

interface RegimeConfig {
  pairActivityMultiplier: number;
  volatilityMultiplier: number;
  arbChanceMultiplier: number;
}

const REGIME_CONFIGS: Record<MarketRegime, RegimeConfig> = {
  quiet:  { pairActivityMultiplier: 0.3, volatilityMultiplier: 0.5, arbChanceMultiplier: 0.3 },
  normal: { pairActivityMultiplier: 1.0, volatilityMultiplier: 1.0, arbChanceMultiplier: 1.0 },
  burst:  { pairActivityMultiplier: 2.0, volatilityMultiplier: 3.0, arbChanceMultiplier: 2.5 },
};

// Markov chain transition probabilities (per tick)
const REGIME_TRANSITIONS: Record<MarketRegime, Record<MarketRegime, number>> = {
  quiet:  { quiet: 0.94, normal: 0.05, burst: 0.01 },
  normal: { quiet: 0.10, normal: 0.87, burst: 0.03 },
  burst:  { quiet: 0.05, normal: 0.15, burst: 0.80 },
};
```

This gives approximate steady-state distribution:
- **Quiet**: ~60% of time — few pair updates, low volatility, rare opportunities
- **Normal**: ~30% of time — moderate activity
- **Burst**: ~10% of time — many pairs affected, correlated moves, higher arb chance

### 8.6 SIMULATION_REALISM_LEVEL Env Var

```typescript
/**
 * Simulation realism levels:
 * - 'low': Current behavior (flat 1000ms, all pairs, fast iteration)
 * - 'medium': Block-time aligned + activity tiers (default)
 * - 'high': Full regime model + all strategy types
 */
export type SimulationRealismLevel = 'low' | 'medium' | 'high';

export function getSimulationRealismLevel(): SimulationRealismLevel {
  const level = process.env.SIMULATION_REALISM_LEVEL?.toLowerCase();
  if (level === 'low' || level === 'medium' || level === 'high') return level;
  return 'medium'; // sensible default
}
```

| Feature | Low | Medium | High |
|---------|-----|--------|------|
| Chain intervals | Flat 1000ms | Block-time aligned | Block-time aligned |
| Pair activity | All pairs every tick | Activity tiers | Activity tiers |
| Market regimes | No | No | Yes (quiet/normal/burst) |
| Strategy types | 5 types (legacy) | 13 types | 13 types |
| Est. events/sec | ~600 | ~80-120 | ~50-100 |

---

## 9. Files to Modify

| File | Changes |
|------|---------|
| `shared/core/src/simulation/types.ts` | Expand `SimulatedOpportunityType` to all 13 types |
| `shared/core/src/simulation/constants.ts` | Add `PAIR_ACTIVITY_TIERS`, `STRATEGY_WEIGHTS`, `REGIME_CONFIGS` |
| `shared/core/src/simulation/chain-simulator.ts` | Block-time intervals, activity tiers, regime model, strategy generators |
| `shared/core/src/simulation/cross-chain-simulator.ts` | Use block-time for update interval |
| `shared/core/src/simulation/price-simulator.ts` | Use block-time for update interval |
| `shared/core/src/simulation/mode-utils.ts` | Add `getSimulationRealismLevel()` |
| `services/unified-detector/src/simulation/chain.simulator.ts` | Wire Solana `type: 'solana'` |
| `services/unified-detector/src/constants.ts` | Add realism level validation |

**Tests to update**: Any test asserting `type: 'intra-chain'` must change to `type: 'cross-dex'` or `type: 'simple'`.
