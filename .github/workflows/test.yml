name: Test Suite

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  schedule:
    # Weekly fork tests: Monday 3 AM UTC
    - cron: '0 3 * * 1'

# Minimum permissions for security (least privilege)
permissions:
  contents: read
  pull-requests: read
  checks: write

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Unit Tests - Shard across 3 jobs for maximum parallelism
  # ===========================================================================
  unit-tests:
    name: Unit Tests (Shard ${{ matrix.shard }}/3)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false  # Run all shards even if one fails
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci


      - name: Run Unit Tests (Shard ${{ matrix.shard }}/3)
        run: npm test -- --selectProjects unit --shard=${{ matrix.shard }}/3 --ci --coverage --coverageThreshold='{}'
        env:
          CI: true

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: unit-shard-${{ matrix.shard }}
          fail_ci_if_error: false  # Don't fail if codecov upload fails

      - name: Upload Slow Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: slow-tests-unit-shard-${{ matrix.shard }}
          path: slow-tests.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # Integration Tests - Shard across 2 jobs with Redis service
  # ===========================================================================
  integration-tests:
    name: Integration Tests (Shard ${{ matrix.shard }}/2)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    services:
      redis:
        image: redis:7.2-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci

      - name: Install Redis CLI
        run: sudo apt-get update && sudo apt-get install -y redis-tools

      - name: Verify Redis connection
        run: |
          redis-cli -h localhost -p 6379 ping

      - name: Run Integration Tests (Shard ${{ matrix.shard }}/2)
        run: npm test -- --selectProjects integration --shard=${{ matrix.shard }}/2 --ci --coverage --coverageThreshold='{}'
        env:
          CI: true
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: integration-shard-${{ matrix.shard }}
          fail_ci_if_error: false

      - name: Upload Slow Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: slow-tests-integration-shard-${{ matrix.shard }}
          path: slow-tests.json
          retention-days: 30
          if-no-files-found: ignore

  # ===========================================================================
  # E2E Tests - No sharding (few tests, must be serial)
  # ===========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      redis:
        image: redis:7.2-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci

      - name: Install Redis CLI
        run: sudo apt-get update && sudo apt-get install -y redis-tools

      - name: Run E2E Tests
        run: npm test -- --selectProjects e2e --ci --coverage --coverageThreshold='{}'
        env:
          CI: true
          REDIS_URL: redis://localhost:6379
          REDIS_HOST: localhost
          REDIS_PORT: 6379

      - name: Upload Coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: e2e
          fail_ci_if_error: false

  # ===========================================================================
  # Performance Tests - No sharding (must be serial for accurate measurements)
  # ===========================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci

      - name: Run Performance Tests
        run: npm test -- --selectProjects performance --ci
        env:
          CI: true

      - name: Upload Performance Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: |
            slow-tests.json
            performance-*.json
          retention-days: 90
          if-no-files-found: ignore

  # ===========================================================================
  # Smoke Tests - Quick validation checks
  # ===========================================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    services:
      redis:
        image: redis:7.2-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci

      - name: Run Smoke Tests
        run: npm test -- --selectProjects smoke --ci
        env:
          CI: true
          REDIS_URL: redis://localhost:6379

  # ===========================================================================
  # Fork Tests - Mainnet fork integration tests (weekly + contract changes)
  # ===========================================================================
  fork-tests:
    name: Fork Tests (Mainnet)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Run on schedule (weekly) OR when contract files change on push/PR
    if: |
      github.event_name == 'schedule' ||
      (
        (github.event_name == 'push' || github.event_name == 'pull_request') &&
        contains(toJSON(github.event.commits.*.modified), 'contracts/') ||
        contains(toJSON(github.event.commits.*.added), 'contracts/') ||
        contains(toJSON(github.event.head_commit.modified), 'contracts/') ||
        contains(toJSON(github.event.head_commit.added), 'contracts/')
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: cd contracts && npx hardhat compile

      - name: Run Fork Tests
        run: cd contracts && npx hardhat test test/FlashLoanArbitrage.fork.test.ts
        env:
          FORK_ENABLED: 'true'
          ETHEREUM_RPC_URL: ${{ secrets.ETHEREUM_RPC_URL != '' && secrets.ETHEREUM_RPC_URL || 'https://eth.llamarpc.com' }}

  # ===========================================================================
  # Code Quality - Lint and Type Check
  # ===========================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript compiler
        run: npm run typecheck

      - name: Run linter
        run: npm run lint

      - name: Validate router approvals (I2 fix)
        run: npm run validate:routers:all
        continue-on-error: true  # Don't fail CI yet, just warn

  # ===========================================================================
  # Test Summary - Aggregate results and report
  # ===========================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, smoke-tests, fork-tests, code-quality]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "E2E Tests: ${{ needs.e2e-tests.result }}"
          echo "Performance Tests: ${{ needs.performance-tests.result }}"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "Fork Tests: ${{ needs.fork-tests.result }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"

      - name: Warn if fork tests failed (non-scheduled)
        if: |
          needs.fork-tests.result == 'failure' &&
          github.event_name != 'schedule'
        run: |
          echo "::warning::Fork tests failed â€” this is informational for push/PR runs and does not block CI."

      - name: Fail if fork tests failed (scheduled)
        if: |
          needs.fork-tests.result == 'failure' &&
          github.event_name == 'schedule'
        run: |
          echo "::error::Fork tests failed on scheduled weekly run."
          exit 1

      - name: Fail if any required job failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.e2e-tests.result == 'failure' ||
          needs.code-quality.result == 'failure'
        run: exit 1
