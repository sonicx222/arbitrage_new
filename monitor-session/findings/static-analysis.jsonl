{"phase":"STATIC","findingId":"SA-001","category":"STREAM_HARDCODING","severity":"MEDIUM","title":"Hardcoded stream name fallback in mempool-detector production code","service":"mempool-detector","evidence":"services/mempool-detector/src/index.ts:117 — opportunityStream: MEMPOOL_CONFIG.streams.pendingOpportunities ?? 'stream:pending-opportunities'","expected":"All stream names should reference RedisStreams constants from @arbitrage/types, not hardcoded strings","actual":"Fallback uses hardcoded string 'stream:pending-opportunities' instead of RedisStreams.PENDING_OPPORTUNITIES","recommendation":"Replace hardcoded fallback with: MEMPOOL_CONFIG.streams.pendingOpportunities ?? RedisStreams.PENDING_OPPORTUNITIES"}
{"phase":"STATIC","findingId":"SA-002","category":"STREAM_HARDCODING","severity":"LOW","title":"Hardcoded stream name strings in JSDoc/comments in production code","service":"coordinator","evidence":"services/coordinator/src/opportunities/opportunity-router.ts:97-99 — JSDoc references 'stream:forwarding-dlq' and 'stream:dead-letter-queue' as string literals; services/coordinator/src/coordinator.ts:305 — comment references 'stream:forwarding-dlq'","expected":"Even comments/JSDoc should reference constant names for maintainability","actual":"Stream names hardcoded in JSDoc and comments rather than referencing RedisStreams.FORWARDING_DLQ","recommendation":"Use constant references in comments: RedisStreams.FORWARDING_DLQ instead of string literals"}
{"phase":"STATIC","findingId":"SA-003","category":"CONSUMER_GROUP","severity":"MEDIUM","title":"Unexpected consumer group 'arbitrage-group' in stream-health-monitor","service":"shared/core","evidence":"shared/core/src/monitoring/stream-health-monitor.ts:122 — private defaultConsumerGroup = 'arbitrage-group'","expected":"Consumer groups should be one of: coordinator-group, cross-chain-detector-group, execution-engine-group, mempool-detector-group","actual":"StreamHealthMonitor uses 'arbitrage-group' which does not match any known service consumer group. This means XPENDING queries in health monitoring will target a non-existent group or create a phantom group.","recommendation":"Change default to match the service using the monitor (e.g., coordinator-group) or make it a required constructor parameter"}
{"phase":"STATIC","findingId":"SA-004","category":"CONSUMER_GROUP","severity":"INFO","title":"All expected consumer groups present in production code","service":"cross-service","evidence":"coordinator-group (coordinator.ts:368), cross-chain-detector-group (detector.ts:331,337,344), execution-engine-group (opportunity.consumer.ts:168, fast-lane.consumer.ts:102)","expected":"All 4 core consumer groups present: coordinator-group, cross-chain-detector-group, execution-engine-group, mempool-detector-group","actual":"coordinator-group, cross-chain-detector-group, execution-engine-group found in production service source. mempool-detector-group found only in test files (service is producer-only, no consumer group needed).","recommendation":"None — mempool-detector is a producer, not a consumer"}
{"phase":"STATIC","findingId":"SA-005","category":"MAXLEN_BYPASS","severity":"HIGH","title":"Multiple services use raw xadd() without MAXLEN enforcement","service":"coordinator,execution-engine,partition-solana","evidence":"coordinator.ts:946 uses xadd() for health alerts; coordinator.ts:1988 uses xadd() for HEALTH stream; partition-solana/arbitrage-detector.ts:808 uses xadd() for OPPORTUNITY_STREAM; opportunity-router.ts:486 uses xadd() with manual maxLen; execution-engine/engine.ts:1218 uses xadd() for EXECUTION_RESULTS; circuit-breaker-manager.ts:365 uses xadd(); standby-manager.ts:245 uses xadd(); health-monitoring-manager.ts:243 uses xadd()","expected":"All xadd calls should use xaddWithLimit() which automatically applies STREAM_MAX_LENGTHS","actual":"11 call sites in services/ use raw .xadd() instead of .xaddWithLimit(). Only opportunity-router.ts manually passes maxLen option. The rest have no MAXLEN, risking unbounded stream growth.","recommendation":"Replace all .xadd() calls with .xaddWithLimit() to enforce automatic MAXLEN trimming. The xaddWithLimit() method exists specifically for this purpose and looks up STREAM_MAX_LENGTHS automatically."}
{"phase":"STATIC","findingId":"SA-006","category":"MAXLEN_BYPASS","severity":"MEDIUM","title":"Shared core services use raw xadd() without MAXLEN","service":"shared/core","evidence":"enhanced-health-monitor.ts:301 uses xadd(); cross-region-health.ts:870 uses xadd() with manual maxLen:10000; expert-self-healing-manager.ts:186 uses xadd() with manual maxLen:10000; dual-publish.ts:35 uses xadd(); stream-consumer.ts:242 uses xadd() for DLQ messages","expected":"All xadd calls should use xaddWithLimit() for automatic MAXLEN lookup","actual":"5 call sites in shared/core/src/ use raw .xadd() — some with manual maxLen that may not match STREAM_MAX_LENGTHS values, others with no maxLen at all","recommendation":"Migrate to xaddWithLimit() for consistency. If custom limits are needed, update STREAM_MAX_LENGTHS rather than passing ad-hoc values."}
{"phase":"STATIC","findingId":"SA-007","category":"XACK","severity":"INFO","title":"XACK properly handled by StreamConsumer with autoAck and error-based retry","service":"shared/core","evidence":"shared/core/src/redis/stream-consumer.ts:330-337 — autoAck=true by default, XACK called after successful handler execution. Failed messages are NOT ACKed (line 345 comment), enabling retry. DLQ cleanup at lines 242-258 ACKs stuck messages.","expected":"Messages acknowledged after processing, failed messages retained for retry","actual":"StreamConsumer correctly implements ACK-after-process with configurable autoAck, exponential backoff on errors, and DLQ routing for stuck messages exceeding maxDeliveryCount.","recommendation":"None — implementation is correct"}
{"phase":"STATIC","findingId":"SA-008","category":"NULLISH_COALESCING","severity":"INFO","title":"No || 0 or || 0n anti-pattern in production source files","service":"cross-service","evidence":"Grep for '|| 0' and '|| 0n' in services/**/src/**/*.ts and shared/**/src/**/*.ts returned zero matches","expected":"No instances of || 0 or || 0n in production code (should use ?? 0)","actual":"Zero occurrences found in production source files. All matches are in test files only.","recommendation":"None — production code is clean"}
{"phase":"STATIC","findingId":"SA-009","category":"NULLISH_COALESCING","severity":"LOW","title":"Coordinator uses || for string defaults instead of ??","service":"coordinator","evidence":"services/coordinator/src/coordinator.ts:368 — consumerGroup: config?.consumerGroup || 'coordinator-group'; line 369 — consumerId: config?.consumerId || instanceId","expected":"Use ?? (nullish coalescing) consistently, even for string values","actual":"Uses || which would replace empty string '' with the default. While unlikely to cause issues (empty string consumer group is invalid), it violates the codebase convention of preferring ?? over ||.","recommendation":"Change to ?? for consistency: consumerGroup: config?.consumerGroup ?? 'coordinator-group'"}
{"phase":"STATIC","findingId":"SA-010","category":"HMAC_SIGNING","severity":"INFO","title":"HMAC signing enforced in production with fail-closed semantics","service":"shared/core","evidence":"shared/core/src/redis/streams.ts:454 — throws Error when NODE_ENV=production and signingKey is not set. STREAM_SIGNING_KEY documented at .env.example:461. Key rotation supported via STREAM_SIGNING_KEY_PREVIOUS (.env.example:465). Legacy HMAC compat configurable via LEGACY_HMAC_COMPAT.","expected":"Production requires HMAC signing, dev mode is optional","actual":"Correct fail-closed enforcement: production without STREAM_SIGNING_KEY throws at startup. Dev mode allows unsigned messages.","recommendation":"None — implementation is correct"}
{"phase":"STATIC","findingId":"SA-011","category":"FEATURE_FLAGS","severity":"MEDIUM","title":"Multiple feature flags used in production code but NOT centralized in FEATURE_FLAGS object","service":"shared/config,services","evidence":"FEATURE_MEV_SHARE (mev-config.ts:33), FEATURE_ADAPTIVE_RISK_SCORING (mev-config.ts:178, mev-risk-analyzer.ts:561), FEATURE_SOLANA_EXECUTION (strategy-initializer.ts:149), FEATURE_STATISTICAL_ARB (strategy-initializer.ts:285), FEATURE_COW_BACKRUN (cow-backrun-detector.ts, cow-settlement-watcher.ts), FEATURE_FLASHBOTS_PROTECT_L2 (flashbots-protect-l2.provider.ts:81), FEATURE_TIMEBOOST (timeboost-provider.ts:81) — all read process.env directly, not via shared/config/src/feature-flags.ts FEATURE_FLAGS","expected":"All FEATURE_* flags should be centralized in the FEATURE_FLAGS object in feature-flags.ts for single-source-of-truth and validateFeatureFlags() coverage","actual":"7 feature flags are scattered across individual source files, reading process.env directly. They are not included in FEATURE_FLAGS, so validateFeatureFlags() cannot check cross-dependencies or log their state at startup.","recommendation":"Add all 7 flags to FEATURE_FLAGS in feature-flags.ts and update consumers to read from FEATURE_FLAGS instead of process.env directly"}
{"phase":"STATIC","findingId":"SA-012","category":"FEATURE_FLAGS","severity":"LOW","title":"Feature flags in .env.example not all mapped to FEATURE_FLAGS object","service":"shared/config","evidence":".env.example documents FEATURE_SOLANA_EXECUTION (line 824), FEATURE_STATISTICAL_ARB (line 839), FEATURE_COW_BACKRUN (line 849), FEATURE_MEV_SHARE (line 303), FEATURE_ADAPTIVE_RISK_SCORING (line 382), FEATURE_FLASHBOTS_PROTECT_L2 (line 348), FEATURE_TIMEBOOST (line 353), FEATURE_AB_TESTING (line 869). None of these are in the FEATURE_FLAGS object.","expected":"Every FEATURE_* env var in .env.example should have a corresponding entry in FEATURE_FLAGS","actual":"8 documented FEATURE_* env vars have no entry in FEATURE_FLAGS. Some are consumed directly via process.env in various source files, others (FEATURE_AB_TESTING) appear undocumented in code.","recommendation":"Centralize all feature flags into the FEATURE_FLAGS object for unified validation and startup logging"}
{"phase":"STATIC","findingId":"SA-013","category":"RISK_CONFIG","severity":"MEDIUM","title":"Multiple risk env vars from risk-config.ts not documented in .env.example","service":"shared/config","evidence":".env.example documents 6 RISK_* vars (RISK_TOTAL_CAPITAL, RISK_KELLY_MULTIPLIER, RISK_MAX_SINGLE_TRADE, RISK_MIN_EV_THRESHOLD, RISK_MIN_WIN_PROBABILITY, RISK_MAX_LOSS_PER_TRADE). Missing from .env.example: RISK_MAX_DAILY_LOSS, RISK_CAUTION_THRESHOLD, RISK_MAX_CONSECUTIVE_LOSSES, RISK_RECOVERY_MULTIPLIER, RISK_RECOVERY_WINS_REQUIRED, RISK_HALT_COOLDOWN_MS, RISK_CAUTION_MULTIPLIER, RISK_DEFAULT_GAS_COST, RISK_DEFAULT_PROFIT_ESTIMATE, RISK_MIN_SAMPLES, RISK_DEFAULT_WIN_PROBABILITY, RISK_MAX_OUTCOMES_PER_KEY, RISK_CLEANUP_INTERVAL_MS, RISK_OUTCOME_RELEVANCE_MS, RISK_MIN_TRADE_FRACTION, RISK_USE_HISTORICAL_GAS, RISK_PERSIST_TO_REDIS, RISK_REDIS_KEY_PREFIX, RISK_MANAGEMENT_ENABLED, DRAWDOWN_BREAKER_ENABLED, EV_CALCULATOR_ENABLED, POSITION_SIZING_ENABLED","expected":"All env vars consumed by risk-config.ts should be documented in .env.example","actual":"22 risk-related env vars are consumed by risk-config.ts but not documented in .env.example. Operators deploying to production may not know these are configurable.","recommendation":"Add all 22 missing RISK_* / DRAWDOWN_* / EV_* / POSITION_SIZING_* env vars to .env.example under the Risk Management section with their defaults and valid ranges"}
{"phase":"STATIC","findingId":"SA-014","category":"RISK_CONFIG","severity":"INFO","title":"Risk config cross-validation correctly enforced","service":"shared/config","evidence":"risk-config.ts:328-334 validates defaultWinProbability >= minWinProbability (P2-5 fix); risk-config.ts:270-275 requires RISK_TOTAL_CAPITAL in production (FIX 3.3); validation runs at import time and throws in production on error (lines 341-351)","expected":"Cross-validation catches inconsistent risk parameters","actual":"Cross-validation is in place for the most dangerous misconfiguration (default probability below min threshold). Production enforcement for RISK_TOTAL_CAPITAL prevents using the 10 ETH default in production.","recommendation":"None — implementation is correct"}
{"phase":"STATIC","findingId":"SA-015","category":"MAXLEN","severity":"INFO","title":"All 23 Redis streams have MAXLEN defined in STREAM_MAX_LENGTHS","service":"shared/core","evidence":"shared/core/src/redis/streams.ts lines 399-427 — STREAM_MAX_LENGTHS covers all 23 streams from RedisStreams constant (PRICE_UPDATES through SERVICE_DEGRADATION)","expected":"Every stream in RedisStreams constant has a MAXLEN entry","actual":"All 23 streams have MAXLEN entries: PRICE_UPDATES(100K), SWAP_EVENTS(50K), OPPORTUNITIES(10K), WHALE_ALERTS(5K), VOLUME_AGGREGATES(10K), HEALTH(1K), EXECUTION_REQUESTS(5K), PENDING_OPPORTUNITIES(10K), CIRCUIT_BREAKER(5K), SYSTEM_FAILOVER(1K), HEALTH_ALERTS(5K), SYSTEM_COMMANDS(1K), SERVICE_HEALTH(1K), SERVICE_EVENTS(5K), COORDINATOR_EVENTS(5K), EXECUTION_RESULTS(5K), DEAD_LETTER_QUEUE(10K), DLQ_ALERTS(5K), FORWARDING_DLQ(5K), FAST_LANE(5K), SYSTEM_FAILURES(5K), SYSTEM_CONTROL(1K), SYSTEM_SCALING(1K), SERVICE_DEGRADATION(5K)","recommendation":"None — coverage is complete"}
